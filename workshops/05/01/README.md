# Группа 1. Энергосбыт: учёт потребления электроэнергии

## Контекст задачи

Компания «ЭнергоДом» обслуживает многоквартирные дома.  
В каждой квартире фиксируется потребление электроэнергии через умные счётчики.  
Менеджеры и аналитики хотят видеть:

- Текущее потребление
- Историю изменений тарифов
- Корректировки показаний
- Потребления по месяцам

### Сущности

1. *Квартирант* - человек, который живет к квартире и потребляет электричество
    - Идентификатор
    - ФИО
2. *Квартира* — объект недвижимости, по которому ведётся учет расхода электричества
    - Идентификатор
    - Адрес
3. *Счётчик* — прибор, измеряющий его расход
    - Идентификатор
    - Название и модель счетчика
    - *Показания* — значения счетчика в квартире
        - T1 - потребление за дневное время
        - T2 - потребление за ночное время
4. *Тариф* — описывает стоимость кВт/ч
    > ⚠️ Все квартиранты платят по одному тарифу, но сам тариф может меняться со временем
    - Идентификатор
    - Стоимость
5. *События*
    - Подача показаний
    - Корректировка показаний
    - Изменение тарифа

## Возможные бизнес-сценарии

> Пункты с ❗️ - обязательные к выполнению

1. **Подача показаний** ❗️
    - Счётчик фиксирует потребление **каждый месяц**  
    - Нужно хранить **историю** всех показаний  

2. **Корректировка показаний**
    - Ошибка в предыдущем снятии показаний или жалоба жильца  
    - **История** должна фиксировать причину, оригинальное и исправленное значения

3. **Изменение тарифа**  
    - Тариф может меняться с определённой даты  
    - Важно понимать, какой тариф применялся к показаниям за любой месяц  

## Что требуется

1. **Спроектировать модель хранения**, которая позволяет:
    - ❗️Видеть текущее потребление квартиры
    - ❗️Хранить историю
        - ❗️Показаний
        - Корректировок
        - Замены счётчиков
        - Изменений тарифов

2. **Подготовить запросы/выборки**:  
    - ❗️Текущее потребление квартиры  
    - Расчет стоимости к оплате за месяц
    - Среднее потребление по ***дому*** за месяц
    - Пересчитанное потребление после корректировки или изменения тарифа

    > ❗️⚡️ Реализовать шардирование и выбрать оптимальный ключ распределения

3. **Настроить чтение показаний из Kafka**:  
    - ❗️Создать таблицу для хранения показаний из топика `gauges` в `kafka:9092` по схеме:
        - `t1` *Uint32* - показания счетчика потребления за **дневное** время
        - `t2` *Uint32* - показания счетчика потребления за **ночное** время
        - `flat_id` *Uint32* - идентификатор квартиры, являющаяся объектом учета
        - `id` *Uint32* - идентификатор счетчика учета показаний электричества
        - `created_at` *DateTime* - время создания записи

    > ClickHouse умеет работать с Kafka "из коробки" через тип таблица `Kafka()`
    > (подробнее в [документации](https://clickhouse.com/docs/ru/engines/table-engines/integrations/kafka))
    >
    > Подсказка: создается три таблицы (`Kafka()`, `MergeTree()` и `MV`)

### Чек-лист сдачи

1. DDL всех таблиц с пояснением  
2. DML: 5–10 событий, демонстрирующих ключевые сценарии  
3. SELECT-запросы
4. Обосновать выбранные подходы:
    - какие подходы хранения истории использованы  
    - плюсы и минусы модели  
    - как выбранная схема упрощает или усложняет работу с данными

### Вспомогательные материалы

- [Движок таблицы Kafka](https://clickhouse.com/docs/ru/engines/table-engines/integrations/kafka)
- [Документация про Distributed Table (шардирование)](https://clickhouse.com/docs/ru/engines/table-engines/special/distributed)
- [Создание таблиц](https://clickhouse.com/docs/ru/sql-reference/statements/create/table)
- [Вставка данных в таблицы](https://clickhouse.com/docs/ru/sql-reference/statements/insert-into)
- [Джоины таблиц](https://clickhouse.com/docs/ru/sql-reference/statements/select/join)
