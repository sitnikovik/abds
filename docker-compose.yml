version: '3.7'
x-environment: &environment
  CLICKHOUSE_USER: default
  CLICKHOUSE_PASSWORD: ""
  CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
  CLICKHOUSE_CONFIG_max_memory_usage: 30000000000
  CLICKHOUSE_CONFIG_max_partitions_per_insert_block: 100
  CLICKHOUSE_CONFIG_max_concurrent_queries: 20
  CLICKHOUSE_CONFIG_max_threads: 4
  CLICKHOUSE_REPLICATION: "1"

services:
  ch1:
    image: clickhouse/clickhouse-server:25.8
    container_name: ch1
    ports:
      - "8123:8123" # Веб-интерфейс
      - "9000:9000"
    volumes:
      - ./ch1_volume:/var/lib/clickhouse
      - ./config/clickhouse/config.d:/etc/clickhouse-server/config.d:ro
    environment:
      <<: *environment

  ch2:
    image: clickhouse/clickhouse-server:25.8
    container_name: ch2
    ports:
      - "8124:8123" # Веб-интерфейс
      - "9001:9000"
    volumes:
      - ./ch2_volume:/var/lib/clickhouse
      - ./config/clickhouse/config.d:/etc/clickhouse-server/config.d:ro
    environment:
      <<: *environment

  kafka:
    image: confluentinc/cp-kafka:7.6.1 
    container_name: kafka               
    ports:
      - "9092:9092"  # Публичный порт для клиентов
      - "9093:9093"  # Порт для управления кластером
    environment:
      # Уникальный ID ноды в кластере (в KRaft это обязательно)
      KAFKA_NODE_ID: 1
      # Роли: брокер (обработка сообщений) + контроллер (управление метаданными)
      KAFKA_PROCESS_ROLES: broker,controller
      # Слушатели: клиенты на 9092, контроллер на 9093
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      # Адрес для клиентов (внутри docker-сети)
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      # Имя слушателя для controller protocol
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      # Протоколы безопасности (здесь без шифрования)
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      # Список голосующих контроллеров (для консенсуса в KRaft)
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      # Фактор репликации для внутреннего топика офсетов (1 = без репликации)
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      # Минимальное количество синхронных реплик для транзакций
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      # Задержка перебалансировки consumer-групп (0 = без задержки)
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      # Автосоздание топиков при первом обращении            
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      # Количество партиций по умолчанию для новых топиков
      KAFKA_NUM_PARTITIONS: 3
      # Уникальный ID кластера (требуется для KRaft, рандомный)
      CLUSTER_ID: "4L6g3nShT-eMCtK--X86sw"
    volumes:
      - kafka_volume:/var/lib/kafka

  # Веб-интерфейс для управления Kafka (топики, сообщения, consumer-группы)
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      - kafka
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      # Сервер Kafka, к которому подключается UI
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092

  # Продюсер счётчиков показаний электричества в виде сообщений в Kafka (для воркшопа)
  producer:
    build: ./producer
    container_name: producer
    depends_on:
      - kafka
    profiles:
      - manual

  superset:
    build: ./build/superset
    container_name: superset
    ports:
      - "8088:8088"
    environment:
      SUPERSET_SECRET_KEY: "9dfc3c4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f"
    volumes:
      - superset_volume:/app/superset_home
    restart: unless-stopped

volumes:
  ch1_volume:
    driver: local
  ch2_volume:
    driver: local
  kafka_volume:
    driver: local
  superset_volume:
    driver: local